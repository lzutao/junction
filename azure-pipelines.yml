trigger:
  branches:
    include: ['*']
    exclude: ['gh-pages']
  tags:
    exclude: ['*']

jobs:
  - job: 'Windows'
    pool:
      vmImage: vs2017-win2016
    variables:
      MINGW_URL: https://s3-us-west-1.amazonaws.com/rust-lang-ci2/rust-ci-mirror
      RUSTFLAGS: -Ctarget-feature=+crt-static
      RUST_BACKTRACE: 1
    strategy:
      matrix:
        x86_64-windows-msvc:
          TARGET: x86_64-pc-windows-msvc
        i686-windows-msvc:
          TARGET: i686-pc-windows-msvc
        # MinGW Builds
        x86_64-windows-gnu:
          TARGET: x86_64-pc-windows-gnu
          MINGW_ARCHIVE: x86_64-6.3.0-release-posix-seh-rt_v5-rev2.7z
          MINGW_DIR: mingw64
        i686-windows-gnu:
          TARGET: i686-pc-windows-gnu
          MINGW_ARCHIVE: i686-6.3.0-release-posix-dwarf-rt_v5-rev2.7z
          MINGW_DIR: mingw32
    steps:
      - powershell: Set-MpPreference -DisableRealtimeMonitoring $true
        displayName: Disable Windows Defender
      - bash: |
          sh ci/install_rust_windows.sh
          echo '##vso[task.setvariable variable=PATH;]$(PATH);$(USERPROFILE)\.cargo\bin'
        displayName: Install Rust
      - bash: |
          sh ci/install_mingw.sh
          echo '##vso[task.setvariable variable=PATH;]C:\mingw\$(MINGW_DIR)\bin;$(PATH)'
        displayName: Check out MinGW toolchain
        condition: and(succeeded(), variables['MINGW_DIR'])
      - bash: |
          set -x
          rustup target add '$(TARGET)'
        displayName: Install target toolchain
        condition: and(succeeded(), ne(variables['TARGET'], 'x86_64-pc-windows-msvc'))
      - bash: |
          set -ex
          gcc --version
          rustup -Vv
          cargo -Vv
          rustc -Vv
          cargo build -v --target '$(TARGET)'
          cargo test -v --target '$(TARGET)'
        displayName: Script
      - powershell: |
          Set-PSDebug -Trace 1
          Get-ChildItem -Path target\debug\junction-test-*\ | Select-Object FullName, Target
          Get-ChildItem -Path target\debug\junction-test-*\junction | Select-Object FullName, Target
        displayName: List junctions
        condition: failed()
      - bash: sh ci/gdb.sh
        displayName: After failure
        condition: failed()

  - job: 'Rustdoc'
    pool:
      vmImage: vs2017-win2016
    condition: and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    steps:
      - powershell: Set-MpPreference -DisableRealtimeMonitoring $true
        displayName: Disable Windows Defender
      - bash: |
          sh ci/install_rust_windows.sh
          echo '##vso[task.setvariable variable=PATH;]$(PATH);$(USERPROFILE)\.cargo\bin'
        displayName: Install Rust
      - bash: |
          set -ex
          cargo doc --all # --document-private-items
          echo '<meta http-equiv=refresh content=0;url=junction/index.html>' > target/doc/index.html
          cd target/doc
          du -sch
          git init
          git config --local user.name "Azure Pipelines"
          git config --local user.email "azuredevops@microsoft.com"
          git config --local core.autocrlf input
          git add .
          git commit --quiet -m 'Publishing GitHub Pages'
          set +x
          git remote add origin "https://lzutao:$(GH_DEPLOY_KEY)@github.com/lzutao/junction.git"
          set -x
          git push --force origin master:gh-pages
        displayName: 'Build and commit pages'

  - job: 'Clippy'
    pool:
      vmImage: vs2017-win2016
    steps:
      - powershell: Set-MpPreference -DisableRealtimeMonitoring $true
        displayName: Disable Windows Defender
      - bash: |
          sh ci/install_rust_windows.sh
          echo '##vso[task.setvariable variable=PATH;]$(PATH);$(USERPROFILE)\.cargo\bin'
        displayName: Install Rust
      - script: rustup component add clippy
        displayName: Install clippy
        condition: succeeded()
      - script: cargo clippy --all --examples --tests -- -Dwarnings
        displayName: Run Clippy
        condition: succeeded()

  - job: 'Rustfmt'
    pool:
      vmImage: Ubuntu-16.04
    steps:
      - bash: |
          curl -sSLf https://sh.rustup.rs | sh -s -- --default-toolchain=stable -y
          echo '##vso[task.setvariable variable=PATH;]$(PATH):~/.cargo/bin'
        displayName: Install Rust
      - script: rustup component add rustfmt
        displayName: Install rustfmt
        condition: succeeded()
      - script: cargo fmt --all -- --check
        displayName: Run rustfmt
        condition: succeeded()
